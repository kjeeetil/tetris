<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Allow Tailwind CDN runtime to inject its inline stylesheet for utility classes -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self' https://pyscript.net https://cdn.jsdelivr.net https://cdn.tailwindcss.com https://ga.jspm.io data: blob:; script-src 'self' 'unsafe-eval' https://pyscript.net https://cdn.jsdelivr.net https://cdn.tailwindcss.com https://ga.jspm.io; style-src 'self' 'unsafe-inline' https://pyscript.net https://fonts.googleapis.com https://cdn.jsdelivr.net; connect-src 'self' https://pyscript.net https://cdn.jsdelivr.net https://cdn.tailwindcss.com https://ga.jspm.io https://fonts.googleapis.com https://fonts.gstatic.com data: blob:; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:;"
    />
    <title>Tetris</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
    />
    <link rel="stylesheet" href="./styles.css" />
    <script src="./tailwind-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com" defer></script>

  </head>
  <body class="relative min-h-screen overflow-x-hidden font-body antialiased text-shell">
    <a
      class="github-link"
      href="https://github.com/kjeeetil/tetris"
      target="_blank"
      rel="noopener noreferrer"
      aria-label="Fork this project on GitHub"
    >
      <svg class="github-link__icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path
          fill="currentColor"
          d="M12 .5a12 12 0 0 0-3.79 23.4c.6.11.82-.26.82-.58v-2.23c-3.34.72-4.04-1.61-4.04-1.61-.55-1.4-1.34-1.77-1.34-1.77-1.09-.74.08-.72.08-.72 1.2.08 1.84 1.24 1.84 1.24 1.07 1.84 2.81 1.31 3.5 1 .11-.78.42-1.31.76-1.61-2.67-.31-5.47-1.33-5.47-5.91 0-1.31.47-2.39 1.24-3.23-.13-.31-.54-1.56.12-3.25 0 0 1.01-.32 3.3 1.23a11.53 11.53 0 0 1 6 0c2.3-1.55 3.3-1.23 3.3-1.23.66 1.69.25 2.94.12 3.25.77.84 1.24 1.92 1.24 3.23 0 4.6-2.81 5.59-5.49 5.89.43.37.81 1.1.81 2.22v3.29c0 .32.22.7.82.58A12 12 0 0 0 12 .5Z"
        />
      </svg>
      <span class="github-link__text">Fork me on GitHub</span>
    </a>
    <div class="aura-shape aura-shape--1"></div>
    <div class="aura-shape aura-shape--2"></div>
    <div class="aura-shape aura-shape--3"></div>
    <div class="aura-shape aura-shape--4"></div>
    <main class="relative z-10 flex flex-col items-center px-6 py-12 md:py-16 gap-12">
      <header class="max-w-3xl text-center">
        <p class="text-xs uppercase tracking-[0.45em] text-plum/70">AUTO ARCADE</p>
        <h1 class="mt-5 text-4xl md:text-6xl font-display text-citron drop-shadow-[0_18px_40px_rgba(94,74,227,0.35)]">
          Tetris Reinforcement Learning Lab
        </h1>
      </header>
      <noscript>
        <div class="glass-panel noscript-alert px-6 py-4 text-base rounded-3xl">
          JavaScript is disabled. Enable it to play.
        </div>
      </noscript>
      <div class="game relative flex w-full max-w-5xl flex-col items-center gap-10">
        <div class="flex w-full max-w-5xl flex-col items-center gap-4 md:flex-row md:items-start md:justify-center md:gap-6">
          <canvas id="canvas" width="300" height="600" tabindex="0" class="shadow-glow"></canvas>
          <div class="flex w-full max-w-sm flex-col items-center gap-6 md:w-auto md:items-start md:gap-8">
            <div class="flex flex-col items-center gap-3 md:items-start">
              <canvas id="preview" width="140" height="140" class="h-[140px] w-[140px]"></canvas>
            </div>
            <div class="flex flex-col items-center gap-2 md:items-start md:text-left">
              <div id="level" class="text-xs uppercase tracking-[0.45em] text-plum/70">Level: 0</div>
              <div
                id="score"
                class="text-4xl font-display text-citron drop-shadow-[0_14px_35px_rgba(244,247,121,0.35)]"
              >
                Score: 0
              </div>
            </div>
          </div>
        </div>
      </div>
      <section class="flex w-full max-w-3xl flex-col items-center gap-5">
        <div class="controls flex flex-wrap items-center justify-center gap-4">
          <button id="toggle" class="icon-btn" title="Play/Pause" aria-label="Play/Pause">▶</button>
          <button id="reset" class="icon-btn icon-btn--emerald" title="Reset" aria-label="Reset">⟲</button>
        </div>
        <div class="controls flex flex-wrap items-center justify-center gap-4">
          <label for="speed" id="speed-label" class="text-xs uppercase tracking-[0.35em] text-plum/70">
            Speed: <span id="speed-display" class="text-citron">1x</span>
          </label>
          <input id="speed" type="range" min="1" max="50" value="1" class="w-60 md:w-72 accent-citron" />
        </div>
        <div class="controls flex flex-wrap items-center justify-center gap-4">
          <label for="model-select" class="text-xs uppercase tracking-[0.35em] text-plum/70">Model:</label>
          <select id="model-select" class="bg-transparent text-base font-display">
            <option value="linear" selected>Linear (ES)</option>
            <option value="mlp">MLP (engineered features)</option>
            <option value="mlp_raw">MLP (board occupancy)</option>
            <option value="alphatetris">AlphaTetris (ConvNet)</option>
          </select>
          <label
            id="render-toggle-label"
            class="control-toggle"
            title="Show the training board and preview during evolution (slower)"
            data-active="false"
          >
            <input
              id="render-toggle"
              type="checkbox"
              class="control-checkbox"
              aria-label="Show training (slow)"
            />
            <span class="control-toggle__text">Show training (slow)</span>
          </label>
        </div>
        <div id="mcts-controls" class="controls hidden flex flex-wrap items-center justify-center gap-4">
          <label for="mcts-simulations" class="text-xs uppercase tracking-[0.35em] text-plum/70">Simulations</label>
          <input
            id="mcts-simulations"
            type="number"
            min="1"
            max="64"
            step="1"
            value="48"
            class="w-20 bg-transparent text-base font-display text-center"
          />
          <label for="mcts-cpuct" class="text-xs uppercase tracking-[0.35em] text-plum/70">Exploration c<sub>PUCT</sub></label>
          <input
            id="mcts-cpuct"
            type="number"
            min="0.01"
            step="0.05"
            value="1.5"
            class="w-24 bg-transparent text-base font-display text-center"
          />
          <label for="mcts-temperature" class="text-xs uppercase tracking-[0.35em] text-plum/70">Temperature</label>
          <input
            id="mcts-temperature"
            type="number"
            min="0"
            step="0.05"
            value="1"
            class="w-20 bg-transparent text-base font-display text-center"
          />
        </div>
        <div class="controls flex flex-wrap items-center justify-center gap-4">
          <button
            id="download-weights"
            class="icon-btn icon-btn--wide"
            title="Download current model weights"
            aria-label="Download current model weights"
          >
            Save
          </button>
          <button
            id="upload-weights-button"
            class="icon-btn icon-btn--violet icon-btn--wide"
            title="Upload weights from a saved file"
            aria-label="Upload model weights"
          >
            Load
          </button>
          <input id="upload-weights" type="file" accept=".txt,.json,text/plain" class="hidden" />
        </div>
        <div
          id="mlp-config"
          class="glass-panel hidden w-full max-w-3xl flex flex-col items-center gap-4 px-4 py-4 text-sm text-plum/70"
        >
          <p class="text-xs uppercase tracking-[0.35em] text-plum/60">MLP Architecture Controls</p>
          <p class="max-w-xl text-center text-[13px] text-plum/60">
            Adjust the multi-layer perceptron policy before or during training. Choose how many hidden layers to use and how many
            neurons should live in each layer; the model and visualisation update instantly.
          </p>
          <div class="flex flex-wrap items-center justify-center gap-3">
            <label for="mlp-hidden-count" class="text-xs uppercase tracking-[0.35em] text-plum/70">Hidden Layers</label>
            <select id="mlp-hidden-count" class="bg-transparent text-base font-display">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
          </div>
          <div id="mlp-layer-controls" class="flex flex-wrap items-center justify-center gap-4"></div>
        </div>
        <div class="controls flex flex-wrap items-center justify-center gap-4">
          <button
            id="start-training"
            class="icon-btn icon-btn--violet icon-btn--wide"
            title="Start training"
            aria-label="Start training"
          >
            Start
          </button>
          <button
            id="reset-model"
            class="icon-btn icon-btn--emerald icon-btn--wide"
            title="Reset model parameters"
            aria-label="Reset model parameters"
          >
            Reset Model
          </button>
        </div>
        <div class="mt-10 flex w-full flex-col items-center gap-4">
          <span class="text-sm uppercase tracking-[0.45em] text-plum/70 md:text-base">Training Progress</span>
          <canvas
            id="score-plot"
            width="520"
            height="240"
            class="h-[240px] w-full max-w-[520px]"
          ></canvas>
        </div>
      </section>
      <section class="mt-6 w-full max-w-5xl space-y-6">
        <div id="train-status" class="text-center text-xs uppercase tracking-[0.45em] text-mint/70"></div>
        <div
          id="model-architecture"
          class="text-center text-sm uppercase tracking-[0.3em] text-plum/60"
          aria-live="polite"
        ></div>
        <div id="network-viz" aria-label="Network weight visualization" class="glass-panel mx-auto h-[260px] w-full overflow-hidden p-6"></div>
        <div
          id="alpha-metrics-panel"
          class="glass-panel mx-auto w-full max-w-5xl rounded-3xl px-6 py-6 text-left"
        >
          <div class="alpha-metrics-header">
            <div class="alpha-metrics-heading">
              <span class="alpha-metrics-heading__eyebrow">AlphaTetris</span>
              <h3 class="alpha-metrics-heading__title">ConvNet Training Metrics</h3>
              <p class="alpha-metrics-description">
                Pin the latest loss curves directly on the page and toggle the traces you care about while the
                ConvNet trains.
              </p>
            </div>
            <div class="alpha-metrics-actions">
              <div class="alpha-metrics-toggle" role="group" aria-label="AlphaTetris plotting controls">
                <span id="alpha-metrics-toggle-status" class="alpha-metrics-toggle__status">Live</span>
                <button
                  id="alpha-metrics-toggle"
                  type="button"
                  class="alpha-metrics-toggle__button"
                  aria-pressed="true"
                  aria-label="Toggle live plotting of ConvNet metrics"
                >
                  <span class="alpha-metrics-toggle__thumb" aria-hidden="true"></span>
                </button>
              </div>
              <div class="alpha-metrics-control">
                <label for="alpha-metrics-select" class="alpha-metrics-control__label">Show metrics</label>
                <select
                  id="alpha-metrics-select"
                  class="alpha-metrics-select"
                  multiple
                  aria-label="Select which ConvNet metrics to plot"
                >
                  <option value="loss">Total Loss</option>
                  <option value="policy_loss">Policy Loss</option>
                  <option value="value_loss" selected>Value Loss</option>
                  <option value="block_reward">Tetromino Objective Quality</option>
                </select>
              </div>
            </div>
          </div>
          <p id="alpha-metric-empty" class="alpha-metric-empty" aria-live="polite">
            ConvNet loss statistics will appear once AlphaTetris training runs.
          </p>
          <div id="alpha-metric-plots" class="alpha-metric-plots" aria-live="polite"></div>
        </div>
        <div class="mx-auto mt-4 w-full max-w-5xl space-y-2">
          <div class="flex items-center justify-between text-xs uppercase tracking-[0.35em] text-plum/70">
            <span>Model history</span>
            <span id="model-history-label" class="text-mint/80" aria-live="polite">Live (current training)</span>
          </div>
          <input
            id="model-history-slider"
            type="range"
            min="0"
            max="0"
            value="0"
            step="1"
            class="w-full"
            aria-label="Scrub through saved best models by generation"
            disabled
          />
          <div id="model-history-meta" class="text-xs text-plum/70">
            Best-of-generation snapshots will appear as training progresses.
          </div>
        </div>
        <div
          id="diagnostics"
          aria-live="polite"
          class="glass-panel mx-auto h-[240px] w-full max-w-5xl overflow-y-auto p-6 text-left text-sm leading-relaxed text-shell/80"
        ></div>
      </section>
      <section class="w-full max-w-5xl">
        <div class="glass-panel mx-auto mt-8 w-full space-y-6 rounded-3xl px-6 py-8 text-left">
          <div>
            <span class="text-xs uppercase tracking-[0.45em] text-plum/70">Feature Engineering</span>
            <h2 class="mt-2 text-2xl font-display text-citron">Model Inputs Explained</h2>
            <p class="mt-3 text-sm leading-relaxed text-plum/80">
              Each candidate placement is simulated and summarized by handcrafted features before being scored by the linear or
              MLP policy. These descriptors capture board safety, line clears, and surface texture so the agent can balance
              clearing lines with maintaining a stable stack.
            </p>
          </div>
          <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
            <div>
              <dt class="font-semibold text-shell">Lines</dt>
              <dd class="text-sm text-plum/80">Normalized count of cleared lines after the drop (lines ÷ 4).</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Lines²</dt>
              <dd class="text-sm text-plum/80">Square of cleared lines scaled by 16, rewarding multi-line clears.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Single Clear</dt>
              <dd class="text-sm text-plum/80">Indicator that exactly one row was removed by the placement.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Double Clear</dt>
              <dd class="text-sm text-plum/80">Indicator for clearing exactly two lines at once.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Triple Clear</dt>
              <dd class="text-sm text-plum/80">Indicator for clearing exactly three simultaneous lines.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Tetris</dt>
              <dd class="text-sm text-plum/80">Indicator capturing a four-line clear produced by the move.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Holes</dt>
              <dd class="text-sm text-plum/80">Fraction of empty cells trapped beneath blocks within each column.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">New Holes</dt>
              <dd class="text-sm text-plum/80">Share of holes introduced by the placement after clearing any lines.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Bumpiness</dt>
              <dd class="text-sm text-plum/80">Normalized sum of height differences between adjacent columns.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Max Height</dt>
              <dd class="text-sm text-plum/80">Tallest column height scaled by the board height.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Well Sum</dt>
              <dd class="text-sm text-plum/80">Total depth of wells (columns lower than both neighbors) normalized by board area.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Edge Wells</dt>
              <dd class="text-sm text-plum/80">Deepest left or right edge indentation relative to its lone neighbor.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Tetris Well</dt>
              <dd class="text-sm text-plum/80">Depth of the single deepest well when it is unique, scaled by board height.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Contact</dt>
              <dd class="text-sm text-plum/80">Normalized surface area where blocks touch neighbors or the floor.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Row Transitions</dt>
              <dd class="text-sm text-plum/80">Horizontal filled-to-empty transitions counted across each row.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Col Transitions</dt>
              <dd class="text-sm text-plum/80">Vertical filled-to-empty transitions counted down each column.</dd>
            </div>
            <div>
              <dt class="font-semibold text-shell">Aggregate Height</dt>
              <dd class="text-sm text-plum/80">Sum of all column heights normalized by the playable area.</dd>
            </div>
          </dl>
        </div>
      </section>
    </main>
    <script type="module" src="./js/main.js"></script>
  </body>
</html>

